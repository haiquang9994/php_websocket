<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, runial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        function ws_client_run(obj, client) {
            client.onopen = (e) => {
                obj._i = 0
                let message = obj.stacks.shift()
                while (message) {
                    client.send(message)
                    message = obj.stacks.shift()
                }
                obj.client = client
            }
            client.onmessage = (e) => {
                let { name, data } = JSON.parse(e.data)
                let callbacks = obj.events[name]
                callbacks.forEach(callback => {
                    typeof callback === 'function' && callback.call(socket, data)
                })
            }
            client.onclose = () => {
                setTimeout(() => {
                    if (obj._i++ < 9) {
                        ws_client_run(obj, new WebSocket(obj.url))
                    }
                }, 3000)
            }
        }
        class WSClient {
            constructor(url) {
                let id = Math.random().toString(36).substr(2, 9) + Math.random().toString(36).substr(2, 9) + Math.random().toString(36).substr(2, 9)
                this.url = url.replace('http', 'ws') + '?sid=' + id
                this.events = []
                this.stacks = []
                this._i = 0
                this.client = null

                ws_client_run(this, new WebSocket(this.url))
            }
            on(name, callback) {
                if (!this.events[name]) {
                    this.events[name] = []
                }
                this.events[name].push(callback)
            }
            emit(name, data) {
                let message = JSON.stringify({ name, data })
                if (!this.client || this.client.readyState !== 1) {
                    this.stacks.push(message)
                } else {
                    this.client.send(message)
                }
            }
        }

        var socket = new WSClient('http://localhost:7508')

        socket.on('chat', (data) => {
            console.log(data)
        })
        socket.emit('chat', { message: 'Hi' })
        console.log(socket)
    </script>
</body>

</html>